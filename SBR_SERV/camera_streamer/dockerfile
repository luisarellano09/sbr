FROM dustynv/jetson-inference:r36.2.0 as dev

# Install pyrealsense2: https://github.com/dusty-nv/jetson-containers/blob/master/packages/realsense/Dockerfile
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libssl-dev \
        libusb-1.0-0-dev \
        libgtk-3-dev \
        libglfw3-dev \
        libgl1-mesa-dev \
        libglu1-mesa-dev \
        qtcreator 

ARG LIBREALSENSE_VERSION=development

RUN git clone --branch ${LIBREALSENSE_VERSION} --depth=1 https://github.com/IntelRealSense/librealsense && \
    cd librealsense && \
    mkdir build && \
    cd build && \
    cmake \
        -DBUILD_EXAMPLES=false \
        -DFORCE_RSUSB_BACKEND=true \
        -DBUILD_WITH_CUDA=true \
        -DCMAKE_BUILD_TYPE=release \
        -DBUILD_PYTHON_BINDINGS=bool:true \
        -DPYTHON_EXECUTABLE=/usr/bin/python3 \
        -DPYTHON_INSTALL_DIR=$(python3 -c 'import sys; print(f"/usr/lib/python{sys.version_info.major}.{sys.version_info.minor}/dist-packages")') \
        ../ && \
    make -j$(($(nproc)-1)) && \
    make install 

RUN cp librealsense/config/99-realsense-libusb.rules /etc/udev/rules.d/ 

RUN -rf librealsense
  

# Create a directory for the app
WORKDIR /sbr

# Copy source code
RUN rm -rf src
COPY ./src ./src

# Run main.py
CMD ["python3", "-u", "./src/main.py"]